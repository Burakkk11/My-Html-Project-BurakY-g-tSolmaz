<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Uzay Savunması</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&display=swap');
        body { margin: 0; height: 100vh; overflow: hidden; font-family: 'Orbitron', sans-serif; background: #000; color: white; }
        #oyun-alani { position: relative; width: 100vw; height: calc(100vh - 120px); background: radial-gradient(circle at center, #0a0a1a 0%, #000 100%); overflow: hidden; }
        #karakter { position: absolute; bottom: 40px; left: 50%; width: 50px; height: 60px; transform: translateX(-50%); z-index: 100; }
        .gemi-govde { width: 100%; height: 100%; background: #bdc3c7; clip-path: polygon(50% 0%, 100% 70%, 80% 100%, 20% 100%, 0% 70%); border-bottom: 4px solid #00f2fe; }
        #market-ekrani, #death-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 3000; backdrop-filter: blur(8px); background: rgba(0,0,0,0.85); }
        #death-screen { background: rgba(40, 0, 0, 0.9); }
        .panel { background: #111; border: 3px solid #f1c40f; padding: 40px; border-radius: 20px; text-align: center; }
        .death-panel { border-color: #ff0000; box-shadow: 0 0 50px rgba(255, 0, 0, 0.5); }
        .btn { background: #222; color: #f1c40f; border: 2px solid #f1c40f; padding: 15px 30px; margin: 10px; font-family: 'Orbitron'; cursor: pointer; font-weight: bold; }
        .btn:hover { background: #f1c40f; color: #000; }
        .btn-red { color: #ff0000; border-color: #ff0000; font-size: 20px; }
        .btn-red:hover { background: #ff0000; color: #fff; }
        .dusman-gemisi { position: absolute; width: 55px; height: 50px; background: #1a1a1a; clip-path: polygon(50% 100%, 0% 0%, 20% 20%, 50% 10%, 80% 20%, 100% 0%); border: 1px solid #444; }
        .goz { position: absolute; top: 30%; left: 40%; width: 10px; height: 10px; border-radius: 50%; }
        #boss { position: absolute; top: -350px; left: 50%; width: 220px; height: 130px; background: #2d004d; clip-path: polygon(0% 15%, 15% 0%, 85% 0%, 100% 15%, 100% 85%, 70% 85%, 50% 100%, 30% 85%, 0% 85%); z-index: 150; transform: translateX(-50%); transition: top 2s; border: 2px solid #ff00ff; }
        #boss-can-bar { position: absolute; top: 60px; left: 50%; transform: translateX(-50%); width: 300px; height: 12px; border: 2px solid #ff00ff; display: none; background: #000; }
        #boss-doluluk { height: 100%; background: magenta; width: 100%; }
        .mermi { position: absolute; width: 5px; height: 25px; background: #00f2fe; box-shadow: 0 0 15px #00f2fe; }
        .boss-mermi { position: absolute; width: 20px; height: 20px; background: #f1c40f; border-radius: 50%; }
        #alt-panel { height: 120px; background: #0a0a0a; display: flex; flex-direction: column; justify-content: center; align-items: center; border-top: 2px solid #222; }
        .can-bar-cerceve { width: 150px; height: 22px; border: 2px solid #ff4b2b; display: flex; gap: 3px; padding: 2px; }
        .can-parcasi { flex: 1; background: #ff4b2b; }
    </style>
</head>
<body>

<div id="market-ekrani">
    <div class="panel">
        <h1 style="color:#f1c40f">MARKET</h1>
        <p>Skor: <span id="market-skor">0</span></p>
        <button class="btn" onclick="satinAl('can')">CAN +1 (150)</button><br>
        <button class="btn" id="gold-btn" onclick="satinAl('altin')">ALTIN GEMI (500)</button><br>
        <button class="btn" onclick="duraklatmaKapat()">DEVAM ET</button>
    </div>
</div>

<div id="death-screen">
    <div class="panel death-panel">
        <h1 style="color:#ff0000; font-size: 60px; margin: 0;">ÖLDÜN</h1>
        <div style="margin: 30px 0; font-size: 24px;">
            <div>SKOR: <span id="final-skor" style="color:#f1c40f">0</span></div>
            <div>SÜRE: <span id="final-zaman" style="color:#00f2fe">0</span>s</div>
        </div>
        <button class="btn btn-red" onclick="location.reload()">TEKRAR DENE</button>
    </div>
</div>

<div id="oyun-alani">
    <div id="ust-panel" style="position: absolute; top: 15px; width: 100%; display: flex; justify-content: space-between; padding: 0 40px; color: #00f2fe; z-index: 1000; box-sizing: border-box;">
        <div id="skor-yazi">Skor: 0</div>
        <div id="zaman-yazi">Zaman: 0s</div>
    </div>
    <div id="boss-can-bar"><div id="boss-doluluk"></div></div>
    <div id="boss"></div>
    <div id="karakter"><div class="gemi-govde" id="gemi-gorsel"></div></div>
</div>

<div id="alt-panel">
    <div style="display: flex; width: 100%; justify-content: space-around; align-items: center;">
        <div class="can-bar-cerceve" id="can-bari"></div>
        <button style="padding: 15px 40px; background:red; color:white; font-family:'Orbitron'; font-weight:bold; cursor:pointer;" onmousedown="atesEt()">ATES ET</button>
    </div>
    <div style="color: #555; font-size: 12px; margin-top: 10px;">ESC: MARKET / DURAKLAT</div>
</div>

<script>
let aCtx = null;
function initAudio() { if(!aCtx) aCtx = new (window.AudioContext || window.webkitAudioContext)(); if(aCtx.state === 'suspended') aCtx.resume(); }

function sFx(f, t, d, v, sweep=0) {
    if(!aCtx) return;
    const o = aCtx.createOscillator(); const g = aCtx.createGain();
    o.type = t; o.frequency.setValueAtTime(f, aCtx.currentTime);
    if(sweep) o.frequency.exponentialRampToValueAtTime(sweep, aCtx.currentTime + d);
    g.gain.setValueAtTime(v, aCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.01, aCtx.currentTime + d);
    o.connect(g); g.connect(aCtx.destination);
    o.start(); o.stop(aCtx.currentTime + d);
}

let skor = 0, can = 5, oyunBitti = false, duraklatildi = false;
let sureSaniye = 0, zamanSayaci = 0, dusmanSayaci = 0;
let gemiPosX = window.innerWidth / 2, gemiPosY = 40; 
let bossModu = false, bossCan = 100, kacinciBoss = 0, altinGemi = false;
let lastTime = 0, bAtes = 0;
const keys = {};

function canGuncelle() {
    const bar = document.getElementById('can-bari'); bar.innerHTML = '';
    for(let i=0; i<can; i++) { const p = document.createElement('div'); p.className = 'can-parcasi'; bar.appendChild(p); }
}
canGuncelle();

function masterLoop(ts) {
    if(!lastTime) lastTime = ts;
    let dt = ts - lastTime; lastTime = ts;
    if (!oyunBitti && !duraklatildi) {
        zamanSayaci += dt;
        if (zamanSayaci >= 1000) {
            sureSaniye++; document.getElementById('zaman-yazi').innerText = "Zaman: " + sureSaniye + "s"; zamanSayaci = 0;
            if (sureSaniye === 30 && kacinciBoss === 0) bossGelsin(100);
            if (sureSaniye === 90 && kacinciBoss === 1) bossGelsin(200);
        }
        if (keys['a'] || keys['arrowleft']) gemiPosX -= 10;
        if (keys['d'] || keys['arrowright']) gemiPosX += 10;
        if (bossModu) {
            if (keys['w'] || keys['arrowup']) gemiPosY = Math.min(gemiPosY + 8, 400);
            if (keys['s'] || keys['arrowdown']) gemiPosY = Math.max(gemiPosY - 8, 40);
        } else { gemiPosY = 40; }
        gemiPosX = Math.max(30, Math.min(window.innerWidth - 30, gemiPosX));
        const k = document.getElementById('karakter'); k.style.left = gemiPosX + 'px'; k.style.bottom = gemiPosY + 'px';
        if (bossModu) {
            bAtes += dt; if (bAtes >= (kacinciBoss === 2 ? 1000 : 1300)) { bossSaldirisi(); bAtes = 0; }
        } else {
            dusmanSayaci += dt; if (dusmanSayaci >= 1400) { dusmanUret(); dusmanSayaci = 0; }
        }
    }
    requestAnimationFrame(masterLoop);
}
requestAnimationFrame(masterLoop);

function atesEt() {
    if(oyunBitti || duraklatildi) return;
    initAudio(); sFx(400, 'sawtooth', 0.1, 0.1, 100);
    if(altinGemi) { mermiYarat(0); mermiYarat(-0.2); mermiYarat(0.2); } else { mermiYarat(0); }
}

function mermiYarat(a) {
    const m = document.createElement('div'); m.className = 'mermi'; m.style.left = gemiPosX + 'px'; m.style.bottom = (gemiPosY + 60) + 'px';
    document.getElementById('oyun-alani').appendChild(m);
    let vX = Math.sin(a) * 5, vY = 15, curX = gemiPosX, curB = gemiPosY + 60;
    let mMove = setInterval(() => {
        if(duraklatildi || oyunBitti) return;
        curB += vY; curX += vX; m.style.bottom = curB + 'px'; m.style.left = curX + 'px';
        if (curB > window.innerHeight) { m.remove(); clearInterval(mMove); return; }
        document.querySelectorAll('.dusman-gemisi').forEach(d => {
            if (d.getAttribute('data-dead') === '0' && isColliding(m, d)) {
                d.setAttribute('data-dead', '1'); sFx(150, 'square', 0.2, 0.1, 40);
                d.remove(); m.remove(); clearInterval(mMove); skor += 10; arayuzGuncelle();
            }
        });
        if (bossModu && isColliding(m, document.getElementById('boss'))) {
            bossCan -= 2; sFx(80, 'sine', 0.1, 0.15);
            let mc = kacinciBoss === 2 ? 200 : 100;
            document.getElementById('boss-doluluk').style.width = (bossCan / mc * 100) + "%";
            m.remove(); clearInterval(mMove); if (bossCan <= 0) bossYokEt();
        }
    }, 20);
}

function duraklatmaAc() { duraklatildi = true; document.getElementById('market-skor').innerText = skor; document.getElementById('market-ekrani').style.display = 'flex'; }
function duraklatmaKapat() { duraklatildi = false; document.getElementById('market-ekrani').style.display = 'none'; initAudio(); }

function satinAl(t) {
    initAudio();
    if(t === 'can' && skor >= 150) { skor -= 150; can = Math.min(can + 1, 8); canGuncelle(); arayuzGuncelle(); sFx(500, 'sine', 0.4, 0.2, 800); } 
    else if(t === 'altin' && skor >= 500 && !altinGemi) {
        skor -= 500; altinGemi = true; document.getElementById('gemi-gorsel').style.background = 'gold'; document.getElementById('gold-btn').innerText = "ALINDI"; arayuzGuncelle(); sFx(200, 'square', 0.6, 0.2, 1000);
    }
    document.getElementById('market-skor').innerText = skor;
}

window.addEventListener('keydown', e => { if(e.key === 'Escape' && !oyunBitti) duraklatildi ? duraklatmaKapat() : duraklatmaAc(); keys[e.key.toLowerCase()] = true; });
window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);

function dusmanUret() {
    if(bossModu || duraklatildi || oyunBitti) return;
    const d = document.createElement('div'); d.className = 'dusman-gemisi';
    d.style.left = Math.random() * (window.innerWidth - 60) + 'px'; d.style.top = '-60px'; d.setAttribute('data-dead', '0');
    const goz = document.createElement('div'); goz.className = 'goz';
    goz.style.background = Math.random() > 0.5 ? 'red' : 'black';
    if(goz.style.background === 'red') goz.style.boxShadow = '0 0 10px red';
    d.appendChild(goz); document.getElementById('oyun-alani').appendChild(d);
    let move = setInterval(() => {
        if(duraklatildi || oyunBitti) return;
        if(d.getAttribute('data-dead') === '1') { clearInterval(move); return; }
        let t = parseInt(d.style.top); d.style.top = (t + 4) + 'px';
        if (isColliding(d, document.getElementById('karakter'))) { d.setAttribute('data-dead', '1'); hasarAl(); d.remove(); clearInterval(move); }
        else if (t > window.innerHeight - 150) { d.setAttribute('data-dead', '1'); hasarAl(); d.remove(); clearInterval(move); }
    }, 20);
}

function bossSaldirisi() {
    let mc = kacinciBoss === 2 ? 200 : 100; let y = (bossCan / mc) * 100;
    if(y >= 70) bossMermiSik(0, 7); else if(y >= 30) { bossMermiSik(-0.2, 6); bossMermiSik(0, 6); bossMermiSik(0.2, 6); }
    else { for(let i=0; i<8; i++) bossMermiSik((Math.PI*2/8)*i, 5, true); }
}

function bossMermiSik(o, h, s=false) {
    const bm = document.createElement('div'); bm.className = 'boss-mermi';
    const bR = document.getElementById('boss').getBoundingClientRect(); const kR = document.getElementById('karakter').getBoundingClientRect();
    let a = s ? o : Math.atan2(kR.top - bR.bottom, (kR.left + 25) - (bR.left + 110)) + o;
    bm.style.left = (bR.left + 110) + 'px'; bm.style.top = bR.bottom + 'px';
    document.getElementById('oyun-alani').appendChild(bm);
    let cX = bR.left + 110, cY = bR.bottom, vX = Math.cos(a)*h, vY = Math.sin(a)*h;
    let bmMove = setInterval(() => {
        if(duraklatildi || oyunBitti) return;
        cX += vX; cY += vY; bm.style.left = cX + 'px'; bm.style.top = cY + 'px';
        if(isColliding(bm, document.getElementById('karakter'))) { hasarAl(); bm.remove(); clearInterval(bmMove); }
        if(cY > window.innerHeight) { bm.remove(); clearInterval(bmMove); }
    }, 20);
}

function bossGelsin(hp) {
    bossModu = true; bossCan = hp; kacinciBoss++; bAtes = 0; sFx(50, 'sawtooth', 1.5, 0.3, 200);
    document.getElementById('boss').style.top = '80px'; document.getElementById('boss-can-bar').style.display = 'block'; document.getElementById('boss-doluluk').style.width = "100%";
}

function bossYokEt() {
    sFx(40, 'sawtooth', 2, 0.4, 10); bossModu = false; document.getElementById('boss').style.top = '-400px'; document.getElementById('boss-can-bar').style.display = 'none';
    skor += (kacinciBoss * 1000); arayuzGuncelle();
}

function hasarAl() { if(oyunBitti) return; can--; canGuncelle(); sFx(60, 'square', 0.3, 0.4, 20); if(can <= 0) gameOver(); }
function gameOver() {
    oyunBitti = true; sFx(40, 'sawtooth', 3, 0.5, 5); 
    document.getElementById('final-skor').innerText = skor; document.getElementById('final-zaman').innerText = sureSaniye;
    document.getElementById('death-screen').style.display = 'flex';
}

function arayuzGuncelle() { document.getElementById('skor-yazi').innerText = "Skor: " + skor; }
function isColliding(a, b) {
    const r1 = a.getBoundingClientRect(); const r2 = b.getBoundingClientRect();
    return !(r1.left > r2.right || r1.right < r2.left || r1.top > r2.bottom || r1.bottom < r2.top);
}
</script>
</body>
</html>